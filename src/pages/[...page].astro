---
import { getAllDatabases, getDatabaseByName } from "../lib/notion/client";
import type { Database, Page } from "../lib/notion-interfaces";
import {
  importCoverImage,
  modifyFileName,
  urlToFileName,
} from "src/lib/blog-helpers";
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import BaseHead from "@/components/BaseHead.astro";
import { Image } from "astro:assets";

export async function getStaticPaths() {
  const databases = await getAllDatabases();
  const paths = databases.flatMap((database) =>
    database.Pages.filter(
      (page: Page) => page.Name !== "Homepage" && database.Title === "Pages",
    ).map((page: Page) => ({
      params: {
        page: page.Slug,
      },
      props: { page },
    })),
  );
  return paths;
}

interface Props {
  page: Page;
}

const { page } = Astro.props as Props;

// Getting images dynamically with import.meta.glob()
// It only accepts string literals
// https://docs.astro.build/en/recipes/dynamically-importing-images/
// const images = import.meta.glob<{ default: ImageMetadata }>(
//   "/src/assets/notion/**/*.{jpeg,jpg,png,tiff,webp,gif,svg,avif}"
// );

let databases: Database[];

databases = await Promise.all(
  page.DatabasesRef!.map(async (db) => await getDatabaseByName(db.name!)),
);

// Flatten and sort pages
const sortedSubpages = databases
  .flatMap((db) => db.Pages)
  .filter((page) => page.Locale === "en")
  .sort((a, b) => {
    if (!a.DateStart) return 1;
    if (!b.DateStart) return -1;
    return new Date(b.DateStart).getTime() - new Date(a.DateStart).getTime();
  });

let coverList: string[] = [];

sortedSubpages.map((subpages) => {
  let coverUrlBg = "";
  if (subpages.Cover) {
    const url = new URL(subpages.Cover.Url);
    const dir = "media/" + url.pathname.split("/").slice(-2)[0];
    const fileNameConverted = urlToFileName(url);
    const fileNameBgWithSlug = modifyFileName(fileNameConverted, {
      newEnd: "-bg",
      newExtension: "jpg",
    });
    coverUrlBg = `/${dir}/${fileNameBgWithSlug}`;
  }
  coverList.push(coverUrlBg);
});

let coverUrl = "";
if (page.Cover) {
  const url = new URL(page.Cover.Url);
  const dir = "media/" + url.pathname.split("/").slice(-2)[0];
  const fileNameConverted = urlToFileName(url);
  const fileNameWithSlug = modifyFileName(fileNameConverted, {
    // newBeginning: page.Slug.split("/").pop() + "_",
    newExtension: "jpg",
  });
  coverUrl = `${dir}/${fileNameWithSlug}`;
}

// Errors with images? Make sure to build "npm run build"
const images = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/notion/**/*.{jpeg,jpg,png,tiff,webp,gif,svg,avif}",
);

const locale = "en";
---

<html lang="en">
  <head>
    <BaseHead
      title={page.Name}
      description={page.Description}
      coverImage={coverUrl}
      coverAlt={page.CoverAlt || "Cover image"}
      locale={locale}
      viewTransition={true}
      slug={page.Slug}
    />
    {
      coverList.map((cover) => {
        return <link rel="preload" href={cover} as="image" />;
      })
    }
  </head>
  <body class="m-0 h-full max-w-full p-0">
    <Header locale={locale} slug={page.Slug} />
    <main id="main">
      <div class="relative flex flex-col">
        {
          sortedSubpages.map(async (subpage, index) => {
            let image = await importCoverImage(subpage, images);
            return (
              <section aria-label={page.Name} class="relative w-full">
                <ul class="relative w-full space-y-0">
                  <article class="h-vh relative flex h-screen w-full snap-start flex-col overflow-hidden bg-clip-border">
                    <a
                      class="flex h-full w-full transition"
                      href={"/" + subpage.Slug}
                      data-astro-prefetch
                    >
                      <div class="absolute z-20 flex h-full w-full flex-col justify-center text-center transition">
                        <h2 class="font-title bg-black/60 p-2 text-3xl text-balance text-white backdrop-blur-sm md:text-5xl dark:text-white">
                          {subpage.Name}
                        </h2>
                      </div>
                      <div class="absolute flex h-full w-full justify-between">
                        {image && index === 0 ? (
                          <Image
                            class="animate-fade absolute z-10 h-full w-full object-cover object-center"
                            src={image}
                            alt={subpage.CoverAlt}
                            transition:name={subpage.PageId + "-image"}
                            loading="eager"
                            widths={[
                              300,
                              700,
                              1000,
                              1280,
                              1400,
                              1600,
                              image.width,
                            ]}
                            sizes={`(max-width: 300px) 300px, (max-width: 700px) 700px, (max-width: 1000px) 1000px, (max-width: 1280px) 1280px, (max-width: 1400px) 1400px, (max-width: 1600px) 1600px, ${image.width}px`}
                          />
                        ) : (
                          <Image
                            class="animate-fade absolute z-10 h-full w-full object-cover object-center"
                            src={image}
                            alt={subpage.CoverAlt}
                            transition:name={subpage.PageId + "-image"}
                            widths={[
                              300,
                              700,
                              1000,
                              1280,
                              1400,
                              1600,
                              image.width,
                            ]}
                            sizes={`(max-width: 300px) 300px, (max-width: 700px) 700px, (max-width: 1000px) 1000px, (max-width: 1280px) 1280px, (max-width: 1400px) 1400px, (max-width: 1600px) 1600px, ${image.width}px`}
                          />
                        )}
                        <div
                          class="absolute z-0 h-full w-full bg-cover bg-center blur-xl"
                          style={`background-image: url(${coverList[index]})`}
                        />
                      </div>
                    </a>
                  </article>
                </ul>
              </section>
            );
          })
        }
      </div>
    </main>
    <Footer locale={locale} slug={page.Slug} />
    <style>
      html {
        scroll-snap-type: y proximity;
        overflow-y: scroll;
      }
    </style>
  </body>
</html>
